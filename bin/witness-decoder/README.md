# Witness File Decoder

A utility to decode and inspect `.w` witness files generated by the stateless validator.

## Overview

The `.w` witness files contain cryptographic witness data and metadata for blockchain blocks. These binary files use a layered encoding structure:

1. **Outer layer**: bincode serialization of `StateData` struct with BLAKE3 hash verification
2. **Inner layer**: bincode serialization of `WitnessStatus` struct containing witness metadata and data

## File Format

The witness files follow the naming convention: `{block_number}.{block_hash}.w`

### Data Structure

```rust
StateData {
    hash: B256,           // BLAKE3 hash of the inner data for integrity
    data: Vec<u8>         // bincode-serialized WitnessStatus
}

WitnessStatus {
    status: SaltWitnessState,     // Processing state (Idle, Processing, Witnessed, etc.)
    block_hash: BlockHash,        // Block hash
    block_number: BlockNumber,    // Block number  
    pre_state_root: B256,         // Pre-state root for verification
    parent_hash: BlockHash,       // Parent block hash
    lock_time: u64,               // Processing lock timestamp
    blob_ids: Vec<[u8; 32]>,      // Associated blob identifiers
    witness_data: Vec<u8>         // The actual cryptographic witness data
}
```

## Usage

### Build

```bash
cargo build --bin witness-decoder
```

### Basic Usage

Decode a witness file with pretty-printed output:

```bash
cargo run --bin witness-decoder -- --file test_data/stateless/witness/280.0x*.w
```

### JSON Output

Export witness data as JSON:

```bash
cargo run --bin witness-decoder -- --file path/to/witness.w --format json
```

### Hex Dump

Show the first 64 bytes of witness data in hexadecimal:

```bash
cargo run --bin witness-decoder -- --file path/to/witness.w --hex-dump-bytes 64
```

### Hash Verification

The decoder automatically verifies BLAKE3 hash integrity by default. To disable:

```bash
cargo run --bin witness-decoder -- --file path/to/witness.w --verify-hash=false
```

## Command Line Options

- `-f, --file <FILE>`: Path to the .w witness file to decode (required)
- `--format <FORMAT>`: Output format - `pretty` (default), `json`, or `raw`
- `--verify-hash`: Verify BLAKE3 hash integrity (default: true)
- `--hex-dump-bytes <N>`: Show hex dump of first N bytes of witness data (default: 0)

## Example Output

### Pretty Format (Default)
```
=== Witness File Information ===
File: 280.0x03c5cb583df6c35f9dcca041f2aa609fce1ad92e170c96c694ce9a6bd3913df1.w
Block Number: 280
Block Hash: 0x03c5cb583df6c35f9dcca041f2aa609fce1ad92e170c96c694ce9a6bd3913df1
Status: Completed
Pre-State Root: 0xd67f333bc9cc579a55f53c2cae6a6e7ba3575668f07c260ba88db20409d08c00
Parent Hash: 0x23383f519e694f28de5d49d0b034a9f7fbc71c7088dfb3030807911595aee7ed
Lock Time: 1757183252 (unix timestamp)
Blob Count: 0
Witness Data Size: 35398 bytes
Hash Verified: true
```

### JSON Format
```json
{
  "file_name": "280.0x03c5cb583df6c35f9dcca041f2aa609fce1ad92e170c96c694ce9a6bd3913df1.w",
  "block_number": 280,
  "block_hash": "0x03c5cb583df6c35f9dcca041f2aa609fce1ad92e170c96c694ce9a6bd3913df1",
  "status": "Completed",
  "pre_state_root": "0xd67f333bc9cc579a55f53c2cae6a6e7ba3575668f07c260ba88db20409d08c00",
  "parent_hash": "0x23383f519e694f28de5d49d0b034a9f7fbc71c7088dfb3030807911595aee7ed",
  "lock_time": 1757183252,
  "blob_count": 0,
  "blob_ids": [],
  "witness_data_size": 35398,
  "witness_data_hex": "bd000000000000004e000000004b0600...",
  "hash_verified": true
}
```

## Witness States

The `status` field can have the following values:
- `Idle`: No processing has started
- `Processing`: Witness is being generated
- `Witnessed`: Witness has been generated
- `Verifying`: Witness is being verified
- `UploadingStep1`: First upload step in progress
- `UploadingStep2`: Second upload step in progress  
- `Completed`: Witness has been successfully uploaded

## Error Handling

The decoder will report errors for:
- File not found or unreadable
- Corrupted binary data that cannot be deserialized
- Hash verification failures (when `--verify-hash` is enabled)
- Invalid file format or structure

Hash verification failures indicate potential file corruption and will be clearly marked in the output.